<!DOCTYPE html>
<html>
    <head>
        <title>Table</title>
        <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
    </head>
    <body>
        <table class="table-load" data-url="./user.jsonp">
            <thead>
            <th>No.</th>
            <th>id</th>
            <th>email</th>
            <th>username</th>
            <th>updateOn</th>
        </thead>
        <tbody class="table-load-tbody">
            <tr tid ="{_table_id}" tindex="{_table_index}" trindex="{_tr_index}">
                <td>{_tr_number}</td>
                <td>{id}</td>
                <td>{email}</td>
                <td>{username}</td>
                <td>{updateOn}</td>
            </tr>
            <tr>
            </tr>
        </tbody>
    </table>

    <script type="text/javascript">
        "use strict";
        (function() {
            //alert($("#table-user"));
            //tableLoad();
            tableLoadJs();
        })();

        function tableLoad() {
            $(".table-load").each(function(i, table) {
                tableLoadData(i, table);
            });
        }
        function tableLoadData(i, table) {
            var $table = $(table);
            if ($table.data("table-load-done")) {
                return;
            }
            var tableId = $table.attr("id");
            if(!tableId){
                tableId = "table-load-" + i;
                $table.attr("id", tableId);
            }
            $table.data("table-load-index", i);
            var url = $table.attr("data-url");
            var tbody = $(".table-load-tbody", $table);
            var html = tbody.html();
            $.getJSON(url, function(data) {
                var h = "";
                $.each(data, function(index, json) {
                    json["_table_id"] = tableId;
                    json["_table_index"] = i;
                    json["_tr_index"] = index;
                    json["_tr_number"] = index + 1;
                    h += html.formatFromJson(json);
                });
                tbody.html(h);
            });
            $table.data("table-load-done", true);
        }


        function tableLoadJs() {
            var tables = document.getElementsByTagName("table");
            var len = tables.length;
            var i = 0;
            for (i = 0; i < len; i++) {
                var table = tables[i];
                var className = table.className;
                if ("table-load" === className) {
                    tableLoadJsData(i, table);
                }
            }
        }
        function tableLoadJsData(i, table) {
            if (table.getAttribute("table-load-done")) {
                return;
            }
            var tBodies = table.tBodies;
            var len = tBodies.length;
            var tbody = null;
            var i = 0;
            for (i = 0; i < len; i++) {
                var tb = tBodies[i];
                var className = tb.className;
                if ("table-load-tbody" === className) {
                    tbody = tb;
                }
            }
            if (tbody === null) {
                return;
            }
            var tableId = table.getAttribute("id");
            if(!tableId){
                tableId = "table-load-" + i;
                table.setAttribute("id", tableId);
            }
            var url = table.getAttribute("data-url");
            var html = tbody.innerHTML;
            Ajax.getJson(url, function(data) {
                var h = "";
                var len = data.length;
                var index = 0;
                for (index = 0; index < len; index++) {
                    var json = data[index];
                    json["_table_id"] = tableId;
                    json["_table_index"] = i;
                    json["_tr_index"] = index;
                    json["_tr_number"] = index + 1;
                    h += html.formatFromJson(json);
                }
                tbody.innerHTML = h;
            });

            table.setAttribute("table-load-done", true);
        }
    </script>
</body>

</html>
